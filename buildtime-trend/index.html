<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Build trends</title>
<script type="text/javascript" src="config.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script type="text/javascript">
    var Keen=Keen||{configure:function(e){this._cf=e},addEvent:function(e,t,n,i){this._eq=this._eq||[],this._eq.push([e,t,n,i])},setGlobalProperties:function(e){this._gp=e},onChartsReady:function(e){this._ocrq=this._ocrq||[],this._ocrq.push(e)}};(function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://":"http://")+"dc8na2hxrj29i.cloudfront.net/code/keen-2.1.2-min.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})();

// configure Keen.io API client, keenConfig is defined in config.js
Keen.configure(keenConfig);

function updateCharts(period) {
  switch (period) {
    case "day":
      var keenTimeframe = "today";
      var keenInterval = "hourly";
      break;
    default:
	  period = "week";
    case "week":
      var keenTimeframe = "this_7_days";
      var keenInterval = "daily";
      break;
    case "month":
      var keenTimeframe = "this_30_days";
      var keenInterval = "daily";
      break;
    case "year":
      var keenTimeframe = "this_52_weeks";
      var keenInterval = "weekly";
      break;
  }
  
  // update interval selection box
  $('#intervals').val(period);

  // hide title
  document.getElementById("timeframe_title").style.display = "none";

  // visualization code goes here
  Keen.onChartsReady(function() {
    var totalBuilds = new Keen.Metric("builds", {
      analysisType: "count",
      timeframe: keenTimeframe,
    });
    totalBuilds.draw(document.getElementById("metric_total_builds"),
      { label: "Total builds" });
    // display div inline (show it next to the next chart)
    document.getElementById("metric_total_builds").style["display"]= "inline-block";

    var totalBuildsPassed = new Keen.Metric("builds", {
      analysisType: "count",
      timeframe: keenTimeframe,
      filters: [{"property_name":"build.result","operator":"eq","property_value":"passed"}]
    });
    totalBuildsPassed.draw(document.getElementById("metric_total_builds_passed"),
      { label: "Total builds passed" });
    // display div inline (show it next to the next chart)
    document.getElementById("metric_total_builds_passed").style["display"]= "inline-block";

    var totalBuildsFailed = new Keen.Metric("builds", {
      analysisType: "count",
      timeframe: keenTimeframe,
      filters: [{"property_name":"build.result","operator":"in","property_value":["failed","errored"]}]
    });
    totalBuildsFailed.draw(document.getElementById("metric_total_builds_failed"),
      { label: "Total builds failed" });
    // display div inline (show it next to the previous chart)
    document.getElementById("metric_total_builds_failed").style["display"]= "inline-block";

    var seriesStageDuration = new Keen.Series("build_stages", {
      analysisType: "average",
      timeframe: keenTimeframe,
      interval: keenInterval,
      targetProperty: "stage.duration",
      groupBy: "stage.name",
      filters: [{"property_name":"stage.name","operator":"exists","property_value":true}]
    });
    seriesStageDuration.draw(document.getElementById("chart_stage_duration"),
      {
        lineWidth: 2,
        title: "Average build stage duration",
        chartAreaLeft: 75,
        yAxisLabel: "duration [s]"
      }
    );
    // display div inline (show it next to the next chart)
    document.getElementById("chart_stage_duration").style["display"]= "inline-block";
	  
    var metricStageFraction = new Keen.Metric("build_stages", {
      analysisType: "average",
      timeframe: keenTimeframe,
      targetProperty: "stage.duration",
      groupBy: "stage.name",
      filters: [{"property_name":"stage.name","operator":"exists","property_value":true}]
    });
    metricStageFraction.draw(document.getElementById("chart_stage_fraction"),
      { title: "Build stage fraction" });
    // display div inline (show it next to the previous chart)
    document.getElementById("chart_stage_fraction").style["display"]= "inline-block";
    
    var seriesBuilds = new Keen.Series("build_stages", {
      analysisType: "count_unique",
      timeframe: keenTimeframe,
      interval: keenInterval,
      targetProperty: "build.build",
      groupBy: "build.branch"
    });
    seriesBuilds.draw(document.getElementById("builds_chart"),
      {
        lineWidth: 2,
        title: "Number of builds per branch",
        chartAreaLeft: 75,
        yAxisLabel: "build count"
      }
    );
    // display div inline (show it next to the next chart)
    document.getElementById("builds_chart").style["display"]= "inline-block";

    var totalBuildsBranch = new Keen.Metric("build_stages", {
      analysisType: "count_unique",
      timeframe: keenTimeframe,
      targetProperty: "build.build",
      groupBy: "build.branch"
    });
    totalBuildsBranch.draw(document.getElementById("chart_total_builds_branch"),
      { title: "Builds per branch" });
    // display div inline (show it next to the previous chart)
    document.getElementById("chart_total_builds_branch").style["display"]= "inline-block";
  });
}

// add project name to title
function updateTitle() {
  // check if config.projectName is set
  if (config.projectName != null || config.projectName == 'project_name') {
      var title = 'Build trends of project ' + htmlEntities(config.projectName);
      document.getElementById("title").innerHTML = title;
      document.getElementsByTagName("title")[0].innerHTML = title;
  }
}

// escape html characters
// inspired by http://css-tricks.com/snippets/javascript/htmlentities-for-javascript/
function htmlEntities(str) {
  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
}
</script>
</head>
<body onload='updateTitle(); updateCharts();'>
<h1 id="title">Build trends</h1>
<p>Timeframe : 
  <select id="intervals" onchange="updateCharts(this.value)">
    <option value="day">Today</option>
    <option value="week" selected="selected">Last 7 days</option>
    <option value="month">Last 30 days</option>
    <option value="year">Last 12 months</option>
  </select>
</p>
<h2 id="timeframe_title">Last week's builds</h2>
<div>
  <div id="metric_total_builds"></div>
  <div id="metric_total_builds_passed"></div>
  <div id="metric_total_builds_failed"></div>
</div>
<div id="chart_stage_duration"></div>
<div id="chart_stage_fraction"></div>
<div id="builds_chart"></div>
<div id="chart_total_builds_branch"></div>
<p>Powered by <a href="http://ruleant.github.io/buildtime-trend/">Buildtime trend</a> (0.1-dev).<br />
Using the <a href="https://keen.io/">Keen.io</a> API for data analysis and visualisation.</p>
</body>
</html>
