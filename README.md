Buildtime trend
===============


[![Buildtime trend](http://img.shields.io/badge/dev-0.1--dev-blue.svg)](https://github.com/ruleant/buildtime-trend/zipball/master)
[![Build Status](https://travis-ci.org/ruleant/buildtime-trend.svg)](https://travis-ci.org/ruleant/buildtime-trend)
[![Coverage Status](https://coveralls.io/repos/ruleant/buildtime-trend/badge.png?branch=master)](https://coveralls.io/r/ruleant/buildtime-trend?branch=master)
[![Code Health](https://landscape.io/github/ruleant/buildtime-trend/master/landscape.png)](https://landscape.io/github/ruleant/buildtime-trend/master)
[![Scrutinizer Code Quality](https://scrutinizer-ci.com/g/ruleant/buildtime-trend/badges/quality-score.png?b=master)](https://scrutinizer-ci.com/g/ruleant/buildtime-trend/?branch=master)
[![Buildtime trend](http://img.shields.io/badge/buildtime-trend-blue.svg)](http://ruleant.github.io/buildtime-trend/buildtime-trend/)
[![status](https://sourcegraph.com/api/repos/github.com/ruleant/buildtime-trend/badges/status.png)](https://sourcegraph.com/github.com/ruleant/buildtime-trend)

Gather data, analyse and visualise trends of build processes on Continuous Integration platforms

Dependencies
------------

- keen (client for storing build time data as events in Keen.io)
- lxml (python wrapper for libxml2 and libxslt)
- matplotlib v1.2.0 or higher (for drawing the `native` trend graph, can be omitted when only using Keen.io to generate charts. Stackplot requires version v1.2.0)

### Dependency installation

- using pip :

`pip install -r requirements.txt`

- if you want to store data or generate charts in `native` mode :

`pip install -r requirements-native.txt`

- install each dependency individually :

```
pip install keen
pip install lxml
pip install 'matplotlib>=1.2.0'
```

- install as a Debian package :

`apt-get install python-lxml`

Keen.io client is not available as a Debian package, so look at the `pip` instructions above

Usage
-----

First the timestamp recording needs to be initialised :

`source /path/to/init.sh`

This script will detect the location of the build-trend script folder,
adds it to the PATH and cleans logfiles of previous runs.
Executing the init script with `source` is required to export environment variables to the current shell session.

Because the script dir is added to PATH, no path needs to be added
when logging a timestamp :

`timestamp.sh eventname`

This will log the current timestamp to a file and display it on STDOUT.
Repeat this step as much as needed.

When finished, run 

`analyse.sh`

to analyse the logfile with timestamps and print out the results.
It will calculate the duration between the timestamps and add them to
a file with the analysed data of previous builds.
When Keen.io is enabled, the data will be sent to your Keen.io project for analysis.
When run on Travis CI, it will automatically add build/job related info.
Parameter `-m native` will store data in xml format. It is recommended to use Keen.io to store data, see below for details.

To generate a graph from previous builds, run

`generate_trend.py`

It will take the file with analysed data generated by the analyse script and turn it into a trend graph and saves this graph.
Parameter `--mode=native` will create a trend using Python `matplotlib`. It is recommended to use Keen.io to generate graphs, see below for details.
If Keen.io is enabled, `generate_trend.py` can be run without parameters.

Use the `sync-buildtime-trend-with-gh-pages.sh` script when you run it as part of a Travis CI build. See below for details.

Store build time data in xml (native mode)
------------------------------------------

(It is recommended to use Keen.io to store data and generate trends, see below)

To store data in xml, native mode needs to be enabled. The xml file is stored in `trends/buildtimes.xml` by default.

To analyse timestamps and store the analysed data :

`analyse.sh -m native`

See wiki for [data schema of the xml file](https://github.com/ruleant/buildtime-trend/wiki/Structure#data-file-in-native-mode).

To generate a chart from the data stored in the xml file :

`generate_trend.py --mode=native`

This will save a trend image in `trends/trend.png`

Store build time data in Keen.io
--------------------------------

Next to storing your build time data in xml, it can be sent to Keen.io for storage, analysis and generating graphs.

Follow these steps to enable using Keen.io :

1. [Create a Keen.io account](https://keen.io/signup), if you haven't already done so.
2. [Create a project](https://keen.io/add-project) in your Keen.io account.
3. Look up the `project ID`, `Write Key` and `Master key` and assign them to environment variables :
- `export KEEN_PROJECT_ID=<Project ID>`
- `export KEEN_WRITE_KEY=<Write Key>`
- `export KEEN_MASTER_KEY=<Master Key>`

If these environment variables are set, the scripts will detect this and use Keen.io to store data, do analysis and generate graphs.

See wiki for [data schema of data sent to Keen.io](https://github.com/ruleant/buildtime-trend/wiki/Structure#data-structures-in-keen-mode).

Integrate with Travis CI
------------------------

You can integrate Buildtime Trend with your build process on Travis CI :
install and initialise the buildtime trend scripts, add timestamp labels, generate the trend
and synchronise it with your gh-pages branch.

All you need is a github repo, a travis account for your repo and a gh-pages branch to publish the results.

You also need to create an encrypted GH_TOKEN to get write access to your repo (publish results on gh-pages branch) :
- [create](https://github.com/settings/applications) the access token for your github repo, `repo` scope is sufficient
- encrypt the environment variable using the [travis tool](http://docs.travis-ci.com/user/encryption-keys/) :
`travis encrypt GH_TOKEN=github_access_token`
- add the encrypted token to your .travis.yml file (see below)

To enable integration with Keen.io, `KEEN_PROJECT_ID` and `KEEN_WRITE_KEY` should be set (see above):

1. Follow the steps above to create a Keen.io account and project and look up the Project ID
2. Encrypt the project ID using the [travis tool](http://docs.travis-ci.com/user/encryption-keys/) :
`travis encrypt KEEN_PROJECT_ID=<Project ID>` and add it to .travis.yml (see below)
3. For the Write key, the master key of your Keen.io project should be used, because the Write key is too long to encrypt using the Travis encryption tool :
`travis encrypt KEEN_WRITE_KEY=<Master Key>`
4. The master key of your Keen.io project is used to generate a scoped read key:
`travis encrypt KEEN_MASTER_KEY=<Master Key>`

Another option is to export the API master key, generate a scoped key using the Keen.io [Python SDK](https://github.com/keenlabs/KeenClient-Python#create-scoped-keys) and use those keys for write and read access.
 
The generated trend graph and build-data will be put in folder `buildtime-trend` on your `gh-pages` branch.
The trend is available on http://{username}.github.io/{repo_name}/buildtime-trend/index.html

Example `.travis.yml` file :

    language: python
    env:
      global:
        - secure: # your secure GH_TOKEN goes here (required to share trend on gh-pages)
        - secure: # your secure KEEN_PROJECT_ID goes here (required to store data on Keen.io)
        - secure: # your secure KEEN_WRITE_KEY goes here (required to store data on Keen.io)
        - secure: # your secure KEEN_MASTER_KEY goes here (required to generate a scoped read key to generate graphs using the Keen.io API)
    before_install:
      # install and initialise build-trend scripts
      # uncomment one of two options below (stable or development)
      # download latest stable release
      - curl https://codeload.github.com/ruleant/buildtime-trend/tar.gz/0.1-preview | tar -xz --transform s/buildtime-trend-0\.1-preview/buildtime-trend/g
      # use latest development version (clone git repo)
      # - if [[ -d $HOME/buildtime-trend/.git ]]; then cd $HOME/buildtime-trend; git pull; cd ..; else git clone https://github.com/ruleant/buildtime-trend.git $HOME/buildtime-trend; fi
      # initialise buildtime-trend scripts
      - source $HOME/buildtime-trend/init.sh
    install:
      # generate timestamp with label 'install'
      - timestamp.sh install
      # install buildtime-trend dependencies
      - CFLAGS="-O0" pip install -r ${BUILD_TREND_HOME}/requirements.txt
      # install dependencies
    script:
      # generate timestamp with label 'tests'
      - timestamp.sh tests
      # run your tests
    after_success:
      # generate timestamp with label 'after_success'
      - timestamp.sh after_success
      # after_success scripts
      # synchronise buildtime-trend result with gh-pages
      - sync-buildtime-trend-with-gh-pages.sh
    after_failure:
      # synchronise buildtime-trend result with gh-pages
      - sync-buildtime-trend-with-gh-pages.sh

`sync-buildtime-trend-with-gh-pages.sh` has to run in both `after_failure` and `after_success` to report the gathered timestamps.
To enable `native` mode, add `-m native` when calling `sync-buildtime-trend-with-gh-pages.sh`

Bugs and feature requests
-------------------------

Please report bugs and add feature requests in the Github [issue tracker](https://github.com/ruleant/buildtime-trend/issues).


Credits
-------

For an overview of who contributed to create Buildtime trend, see [Credits](https://github.com/ruleant/buildtime-trend/wiki/Credits).

Contact
-------

Website : http://ruleant.github.io/buildtime-trend

Follow us on [Twitter](https://twitter.com/buildtime_trend), [Github](https://github.com/ruleant/buildtime-trend) and [OpenHub](https://www.openhub.net/p/buildtime-trend).


License
-------

Copyright (C) 2014 Dieter Adriaenssens <ruleant@users.sourceforge.net>

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
