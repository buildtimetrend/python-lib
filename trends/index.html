<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Build trends</title>
<script type="text/javascript" src="config.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script type="text/javascript">
  !function(a,b){if(void 0===b[a]){b["_"+a]={},b[a]=function(c){b["_"+a].clients=b["_"+a].clients||{},b["_"+a].clients[c.projectId]=this,this._config=c},b[a].ready=function(c){b["_"+a].ready=b["_"+a].ready||[],b["_"+a].ready.push(c)};for(var c=["addEvent","setGlobalProperties","trackExternalLink","on"],d=0;d<c.length;d++){var e=c[d],f=function(a){return function(){return this["_"+a]=this["_"+a]||[],this["_"+a].push(arguments),this}};b[a].prototype[e]=f(e)}var g=document.createElement("script");g.type="text/javascript",g.async=!0,g.src="https://d26b395fwzu5fz.cloudfront.net/3.0.0/keen.min.js?v0";var h=document.getElementsByTagName("script")[0];h.parentNode.insertBefore(g,h)}}("Keen",this);

// configure Keen.io API client, keenConfig is defined in config.js
var client = new Keen(keenConfig);

function updateCharts(period) {
  switch (period) {
    case "day":
      var keenTimeframe = "today";
      var keenInterval = "hourly";
      break;
    default:
	  period = "week";
    case "week":
      var keenTimeframe = "this_7_days";
      var keenInterval = "daily";
      break;
    case "month":
      var keenTimeframe = "this_30_days";
      var keenInterval = "daily";
      break;
    case "year":
      var keenTimeframe = "this_52_weeks";
      var keenInterval = "weekly";
      break;
  }
  
  // update interval selection box
  $('#intervals').val(period);

  // hide title
  document.getElementById("timeframe_title").style.display = "none";

  // visualization code goes here
  Keen.ready(function() {
    var totalBuilds = new Keen.Query("count", {
      eventCollection: "builds",
      timeframe: keenTimeframe,
    });
    client.draw(totalBuilds, document.getElementById("metric_total_builds"),
      { title: "Total builds", width: "200px" });
    // display div inline (show it next to the next chart)
    document.getElementById("metric_total_builds").style["display"]= "inline-block";

    var totalBuildsPassed = new Keen.Query("count", {
      eventCollection: "builds",
      timeframe: keenTimeframe,
      filters: [{"property_name":"build.result","operator":"eq","property_value":"passed"}]
    });
    client.draw(totalBuildsPassed, document.getElementById("metric_total_builds_passed"),
      { title: "Builds passed", width: "200px" });
    // display div inline (show it next to the next chart)
    document.getElementById("metric_total_builds_passed").style["display"]= "inline-block";

    var totalBuildsFailed = new Keen.Query("count", {
      eventCollection: "builds",
      timeframe: keenTimeframe,
      filters: [{"property_name":"build.result","operator":"in","property_value":["failed","errored"]}]
    });
    client.draw(totalBuildsFailed, document.getElementById("metric_total_builds_failed"),
      { title: "Builds failed", width: "200px" });
    // display div inline (show it next to the previous chart)
    document.getElementById("metric_total_builds_failed").style["display"]= "inline-block";

    var seriesStageDuration = new Keen.Query("average", {
      eventCollection: "build_stages",
      timeframe: keenTimeframe,
      interval: keenInterval,
      targetProperty: "stage.duration",
      groupBy: "stage.name",
      filters: [{"property_name":"stage.name","operator":"exists","property_value":true}]
    });
    client.draw(seriesStageDuration, document.getElementById("chart_stage_duration"),
      {
        chartType: "columnchart",
        title: "Average build stage duration",
        chartOptions: {
          isStacked: true,
          chartArea: {left: 75, width: 350},
          vAxis: {title: "duration [s]"}
        }
      }
    );
    // display div inline (show it next to the next chart)
    document.getElementById("chart_stage_duration").style["display"]= "inline-block";
	  
    var metricStageFraction = new Keen.Query("average", {
      eventCollection: "build_stages",
      timeframe: keenTimeframe,
      targetProperty: "stage.duration",
      groupBy: "stage.name",
      filters: [{"property_name":"stage.name","operator":"exists","property_value":true}]
    });
    client.draw(metricStageFraction, document.getElementById("chart_stage_fraction"),
      { title: "Build stage fraction" });
    // display div inline (show it next to the previous chart)
    document.getElementById("chart_stage_fraction").style["display"]= "inline-block";
    
    var seriesBuilds = new Keen.Query("count_unique", {
      eventCollection: "build_stages",
      timeframe: keenTimeframe,
      interval: keenInterval,
      targetProperty: "build.build",
      groupBy: "build.branch"
    });
    client.draw(seriesBuilds, document.getElementById("builds_chart"),
      {
        chartType: "columnchart",
        title: "Builds per branch (nominal)",
        chartOptions: {
          chartArea: {left: 75, width: 350},
          vAxis: {title: "build count"}
        }
      }
    );
    // display div inline (show it next to the next chart)
    document.getElementById("builds_chart").style["display"]= "inline-block";

    var totalBuildsBranch = new Keen.Query("count_unique", {
      eventCollection: "build_stages",
      timeframe: keenTimeframe,
      targetProperty: "build.build",
      groupBy: "build.branch"
    });
    client.draw(totalBuildsBranch, document.getElementById("chart_total_builds_branch"),
      { title: "Builds per branch (relative)" });
    // display div inline (show it next to the previous chart)
    document.getElementById("chart_total_builds_branch").style["display"]= "inline-block";
  });
}

// add project name to title
function updateTitle() {
  // check if config.projectName is set
  if (config.projectName != null || config.projectName == 'project_name') {
      var title = 'Build trends of project ' + htmlEntities(config.projectName);
      document.getElementById("title").innerHTML = title;
      document.getElementsByTagName("title")[0].innerHTML = title;
  }
}

// escape html characters
// inspired by http://css-tricks.com/snippets/javascript/htmlentities-for-javascript/
function htmlEntities(str) {
  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
}
</script>
</head>
<body onload='updateTitle(); updateCharts();'>
<h1 id="title">Build trends</h1>
<p>Timeframe : 
  <select id="intervals" onchange="updateCharts(this.value)">
    <option value="day">Today</option>
    <option value="week" selected="selected">Last 7 days</option>
    <option value="month">Last 30 days</option>
    <option value="year">Last 12 months</option>
  </select>
</p>
<h2 id="timeframe_title">Last week's builds</h2>
<div>
  <div id="metric_total_builds"></div>
  <div id="metric_total_builds_passed"></div>
  <div id="metric_total_builds_failed"></div>
</div>
<div id="chart_stage_duration"></div>
<div id="chart_stage_fraction"></div>
<div id="builds_chart"></div>
<div id="chart_total_builds_branch"></div>
<p>Powered by <a href="http://ruleant.github.io/buildtime-trend/">Buildtime trend</a> (0.1-dev).<br />
Using the <a href="https://keen.io/">Keen.io</a> API for data analysis and visualisation.</p>
</body>
</html>
