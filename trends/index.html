<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Build trends</title>
<script type="text/javascript" src="config.js"></script>
<script type="text/javascript">
    var Keen=Keen||{configure:function(e){this._cf=e},addEvent:function(e,t,n,i){this._eq=this._eq||[],this._eq.push([e,t,n,i])},setGlobalProperties:function(e){this._gp=e},onChartsReady:function(e){this._ocrq=this._ocrq||[],this._ocrq.push(e)}};(function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://":"http://")+"dc8na2hxrj29i.cloudfront.net/code/keen-2.1.2-min.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})();

// configure Keen.io API client, keenConfig is defined in config.js
Keen.configure(keenConfig);

function updateCharts(period) {
  switch (period) {
    case "day":
      var timeframeTitle = "Today's builds";
      var keen_timeframe = "today";
      var keen_interval = "hourly";
      break;
    default:
    case "week":
      var timeframeTitle = "Last week's builds";
      var keen_timeframe = "this_7_days";
      var keen_interval = "daily";
      break;
    case "month":
      var timeframeTitle = "Last month's builds";
      var keen_timeframe = "this_30_days";
      var keen_interval = "daily";
      break;
    case "year":
      var timeframeTitle = "Last year's builds";
      var keen_timeframe = "this_365_days";
      var keen_interval = "weekly";
      break;
  }

  // update title
 document.getElementById("timeframe_title").innerHTML = timeframeTitle;

  // visualization code goes here
  Keen.onChartsReady(function() {
    var series_week = new Keen.Series("build_stages", {
      analysisType: "average",
      timeframe: keen_timeframe,
      interval: keen_interval,
      targetProperty: "stage.duration",
      groupBy: "stage.name",
      filters: [{"property_name":"stage.name","operator":"exists","property_value":true}]
    });
    series_week.draw(document.getElementById("stage_duration_chart"),
      { lineWidth: 2, title: "Average build stage duration", yAxisLabel: "duration [s]" });

    var series_builds = new Keen.Series("build_stages", {
      analysisType: "count_unique",
      timeframe: keen_timeframe,
      interval: keen_interval,
      targetProperty: "build.build",
      groupBy: "build.branch"
    });
    series_builds.draw(document.getElementById("builds_chart"),
      { lineWidth: 2, title: "Number of builds per branch", yAxisLabel: "build count" });
  });
}

// add project name to title
function updateTitle() {
  // check if config.projectName is set
  if (config.projectName != null || config.projectName == 'project_name') {
      var title = 'Buildtrend of project ' + config.projectName;
      document.getElementById("title").innerHTML = title;
      document.getElementsByTagName("title")[0].innerHTML = title;
  }
}
</script>
</head>
<body onload='updateTitle(); updateCharts("week");'>
<h1 id="title">Build trends</h1>
<p>Time period :
  <select id="intervals" onchange="updateCharts(this.value)">
    <option value="day">Today</option>
    <option value="week" selected="selected">Last week</option>
    <option value="month">Last month</option>
    <option value="year">Last year</option>
  </select>
</p>
<h2 id="timeframe_title">Last week's builds</h2>
<div id="stage_duration_chart"></div>
<div id="builds_chart"></div>
<p>Powered by <a href="http://ruleant.github.io/buildtime-trend/">Buildtime trend</a>.<br />
Using the <a href="https://keen.io/">Keen.io</a> API for data analysis and visualisation.</p>
</body>
</html>
